---
type Product = {
  title: string;
  size: string;
  brand: string;
  location: string;
  image: string;
  hoverimage?: string;
  description: string;
  slug: string;
  wash: string;
  condition: string;
  fit: string;
};

import Productcard from "../../components/productcard.astro";
import Layout from "../../layouts/Layout.astro";
import Banner from "../../components/banner.astro";

export async function getStaticPaths() {
  const res = await fetch("https://uxyaqezkinnmddpsjcht.supabase.co/rest/v1/products", {
    headers: {
      apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4eWFxZXpraW5ubWRkcHNqY2h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0ODMzNDcsImV4cCI6MjA2OTA1OTM0N30.3wwIHSsmdQwUlfCtnIZkJQfoqXJBP4M-NDLDpmaVusI",
      Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4eWFxZXpraW5ubWRkcHNqY2h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0ODMzNDcsImV4cCI6MjA2OTA1OTM0N30.3wwIHSsmdQwUlfCtnIZkJQfoqXJBP4M-NDLDpmaVusI",
    },
  });

  const data: Product[] = await res.json();

  return data.map((product) => ({
    params: { slug: product.slug },
    props: { myData: product },
  }));
}

// Vi hämtar props från getStaticPaths ovan
const { myData }: { myData: Product } = Astro.props;

// Hämta alla produkter igen för att filtrera fram relaterade
const allRes = await fetch("https://uxyaqezkinnmddpsjcht.supabase.co/rest/v1/products", {
  headers: {
    apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4eWFxZXpraW5ubWRkcHNqY2h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0ODMzNDcsImV4cCI6MjA2OTA1OTM0N30.3wwIHSsmdQwUlfCtnIZkJQfoqXJBP4M-NDLDpmaVusI",
    Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4eWFxZXpraW5ubWRkcHNqY2h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0ODMzNDcsImV4cCI6MjA2OTA1OTM0N30.3wwIHSsmdQwUlfCtnIZkJQfoqXJBP4M-NDLDpmaVusI",
  },
});

const allProducts: Product[] = await allRes.json();

const related = allProducts.filter((p) => p.size === myData.size && p.slug !== myData.slug);
---

<Layout>
  <section class="productview">
    <div class="grid_1-1">
      <!-- Bildsida -->
      <div>
        <a href="/location" class="backlink">←</a>
        <div class="hoverimage">
          <img src={myData.image} alt={myData.title} class="productimg front" />
          <img src={myData.hoverimage} alt={myData.title} class="productimg back" />
        </div>
      </div>

      <!-- Infosida -->
      <div class="info">
        <h1 class="title">{myData.title}</h1>
        <a href="/location"><p class="location">{myData.location}</p></a>
        <p class="description">{myData.description}</p>

        <p><strong>Stand</strong><br />{myData.condition}</p>
        <p><strong>Vask</strong><br />{myData.wash}</p>
        <p><strong>Fit</strong><br />{myData.fit}</p>
        <p><strong>Størrelse</strong><br />{myData.size}</p>
        <p><strong>Varumærke</strong><br />{myData.brand}</p>
      </div>
    </div>
  </section>

  <Banner />

  <section class="margin">
    <h2>Andre produkter i størrelse {myData.size}</h2>
    <section class="cardsection">
      {related.length > 0 ? related.map((product) => <Productcard data={product} />) : <p class="noresult">Der er ikke flere styles i denne størrelse.</p>}
    </section>
  </section>
</Layout>

<style>
  .productview {
    margin: 40px 20px 70px 20px;
  }
  .backlink {
    text-decoration: none;
    font-size: 40px;
    display: inline-block;
    margin-top: 1rem;
  }

  .image {
    width: 100%;
    height: 600px;
    border-radius: 5px;
  }

  .hoverimage {
    position: relative;
    width: 100%;
    height: auto;
  }

  .productimg {
    display: block;
    width: 100%;
    height: 600px;
    object-fit: cover;
    transition: opacity 0.3s ease;
    border-radius: 5px;
  }

  .front {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 2;
    opacity: 1;
  }

  .back {
    position: relative;
    z-index: 1;
    opacity: 1;
  }

  .hoverimage:hover .front {
    opacity: 0;
  }

  .info {
    max-width: 500px;
    margin-top: 35px;
  }

  .title {
    font-size: 40px;
    font-style: italic;
    margin-bottom: 0.5rem;
    text-align: left;
  }

  .location {
    background: #e3e3e3;
    display: inline-block;
    padding: 5px 10px;
    border-radius: 3px;
    margin-bottom: 1.5rem;
    font-size: 20px;
    margin-top: 0px;
    font-style: normal;
  }

  .location {
    font-family: Arial, sans-serif;
  }

  .location:hover {
    text-decoration: underline;
  }

  .description {
    line-height: 1.5;
    margin-bottom: 2.5rem;
    max-width: 40ch;
    margin-top: -13px;
  }

  .noresult {
    font-style: italic;
    margin-top: 2rem;
    font-size: 1rem;
  }

  .cardsection {
    margin-top: 10px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 5px;
  }

  @media (min-width: 700px) {
    .grid_1-1 {
      align-items: start;
      margin-top: 40px;
      max-width: 1050px;
      margin: 0 auto; /* centrera hela grid-blocket */
    }

    .cardsection {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      max-width: 1250px;
      gap: 10px;
    }
  }
</style>
